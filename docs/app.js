// Global variable to store all articles
let allArticles = [];

// Helper: Detect YouTube (including Shorts) for video badges
function isYoutubeContent(url, thumbUrl) {
    if (!url) return false;
    // Checks both the URL (watch?v= or shorts/) and the thumbnail host (ytimg.com)
    const ytRegex = /(youtube\.com\/(watch\?v=|shorts\/)|youtu\.be\/)/i;
    const thumbRegex = /ytimg\.com/i;
    return ytRegex.test(url) || (thumbUrl && thumbRegex.test(thumbUrl));
}

// Load articles from pre-generated JSON (generated by GitHub Actions)
async function loadArticlesFromJSON() {
    try {
        console.log('Loading articles from JSON...');
        // Use a daily version to bypass browser caching
        const VERSION = new Date().toISOString().slice(0, 10);
        const response = await fetch(`./mma-news.json?v=${VERSION}`, { cache: 'no-store' });
        
        if (!response.ok) {
            console.warn('JSON file not found. Please run fetch_feeds.py or enable GitHub Actions.');
            return null;
        }
        
        const data = await response.json();
        console.log(`âœ“ Loaded ${data.articles.length} articles from JSON`);
        return data.articles;
    } catch (error) {
        console.warn('Could not load JSON:', error.message);
        return null;
    }
}

// Remove HTML tags from description
function cleanDescription(text) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = text;
    return tempDiv.textContent || tempDiv.innerText || '';
}

// Format date for display
function formatDate(date) {
    const now = new Date();
    const dateObj = new Date(date);
    const diffMs = now - dateObj;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return dateObj.toLocaleDateString();
}

// 1. REVISED: Create HTML for a single article (includes video class and share data)
function createArticleCard(article) {
    const rawImage = article.thumbnail || '';
    const imageUrl = rawImage 
        ? `https://images.weserv.nl/?url=${encodeURIComponent(rawImage)}`
        : './logo-placeholder.png';
    
    const descriptionText = article.description ? cleanDescription(article.description) : '';

    // Video Detection
    const isVideo = isYoutubeContent(article.link, rawImage);
    const wrapperClass = isVideo ? 'thumb-link is-video' : 'thumb-link';
    const ariaLabel = isVideo ? 'aria-label="Watch video"' : '';

    // Sanitize title for data attribute (HTML attribute doesn't like raw quotes)
    const safeTitle = article.title.replace(/"/g, '&quot;');

    return `
        <article data-share-url="${article.link}" data-share-title="${safeTitle}">
            <a href="${article.link}" target="_blank" rel="noopener noreferrer" class="${wrapperClass}" ${ariaLabel}>
                <img src="${imageUrl}" alt="" class="article-thumb" loading="lazy" onerror="this.src='./logo-placeholder.png'">
            </a>
            <div class="article-content">
                <div class="article-source">${article.source}</div>
                <h2 class="article-title">
                    <a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a>
                </h2>
                ${descriptionText ? `<p class="article-description">${descriptionText}</p>` : ''}
                
                <div class="article-footer">
                    <span class="article-date">${formatDate(article.pubDate)}</span>
                    
                    <div class="article-actions">
                        <button class="btn-share" type="button" aria-label="Share this article">
                            <svg viewBox="0 0 24 24">
                                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </article>
    `;
}

// Search function - filters articles based on query
function searchArticles(query) {
    if (!query.trim()) {
        return allArticles;
    }

    const lowerQuery = query.toLowerCase();

    return allArticles.filter(article => {
        const title = article.title.toLowerCase();
        const description = article.description ? article.description.toLowerCase() : '';
        const source = article.source.toLowerCase();

        return title.includes(lowerQuery) || 
               description.includes(lowerQuery) || 
               source.includes(lowerQuery);
    });
}

// Render articles to the DOM
function renderArticles(articles) {
    const container = document.getElementById('articles-container');
    const emptyMsg = document.getElementById('search-empty');
    
    if (articles.length === 0) {
        container.innerHTML = '';
        if(emptyMsg) emptyMsg.style.display = 'block';
    } else {
        if(emptyMsg) emptyMsg.style.display = 'none';
        container.innerHTML = articles
            .map(article => createArticleCard(article))
            .join('');
    }
}

// Handle search input
function setupSearchHandlers() {
    const searchInput = document.getElementById('t2d-q');
    const clearBtn = document.getElementById('clear-search');

    // Prevent form submission
    const searchForm = document.querySelector('form.search');
    if (searchForm) searchForm.addEventListener('submit', (e) => e.preventDefault(), { passive: false });

    if (!searchInput) return;
    
    const performSearch = (val) => {
        renderArticles(searchArticles(val));
        if(clearBtn) clearBtn.style.display = val.length > 0 ? 'block' : 'none';
    };

    // Listen for input changes
    searchInput.addEventListener('input', (e) => performSearch(e.target.value));

    // Clear button functionality
    if(clearBtn) {
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            performSearch('');
            searchInput.focus();
        });
    }
}

// Header shadow on scroll
function setupHeaderScroll() {
    const header = document.querySelector('header.site');
    if (!header) return;

    window.addEventListener('scroll', () => {
        header.classList.toggle('shadow', window.scrollY > 8);
    }, { passive: true });
}

// Main function to load articles
async function loadArticles() {
    const skeletonEl = document.getElementById('loading-skeleton');
    const containerEl = document.getElementById('articles-container');
    
    // Show skeleton loader immediately
    if (skeletonEl) skeletonEl.style.display = 'grid';

    try {
        let articles = await loadArticlesFromJSON();
        
        if (!articles) {
            if(skeletonEl) skeletonEl.style.display = 'none';
            containerEl.innerHTML = '<p style="text-align:center; padding:2rem; color:#888;">No articles available. Please ensure fetch_feeds.py has been run.</p>';
            return;
        }

        allArticles = articles;

        // Hide Skeleton
        if(skeletonEl) skeletonEl.style.display = 'none';

        // Render initial articles
        renderArticles(allArticles);

        // Setup search functionality
        setupSearchHandlers();

        // Update last updated time
        const lastUpdated = document.getElementById('last-updated');
        if (lastUpdated) {
            lastUpdated.textContent = new Date().toLocaleTimeString();
        }
    } catch (error) {
        console.error('Fatal error:', error);
        if(skeletonEl) skeletonEl.style.display = 'none';
        containerEl.innerHTML = '<p style="text-align:center; padding:2rem; color:#888;">Error loading articles.</p>';
    }
}

// 2. NEW: Global Event Delegation for Sharing (Native API)
document.addEventListener('click', async (e) => {
    // Find the closest share button if clicked
    const btn = e.target.closest('.btn-share');
    if (!btn) return;

    const article = btn.closest('article');
    const url = article.dataset.shareUrl;
    const title = article.dataset.shareTitle;

    // A. Native Share API (Mobile/Modern Browsers)
    if (navigator.share) {
        try {
            await navigator.share({
                title: title,
                text: title,
                url: url
            });
        } catch (err) {
            // User cancelled or error, ignore
            console.log('Native Share cancelled/failed:', err);
        }
    } 
    // B. Fallback for Desktop (Copy to Clipboard)
    else {
        try {
            await navigator.clipboard.writeText(url);
            
            // Visual feedback (check mark icon)
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="var(--mma)"/></svg>`;
            setTimeout(() => btn.innerHTML = originalHTML, 2000);
        } catch (err) {
            alert('Could not copy link. Browser access denied.');
        }
    }
});

// === Header Date (auto) ===
function initHeaderDate(){
    const el = document.getElementById('hdr-date');
    if (!el) return;
    try {
        const now = new Date();
        el.textContent = now.toLocaleDateString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric' 
        }).toUpperCase();
    } catch (e) {
        console.error("Could not set header date:", e);
    }
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    loadArticles();
    setupHeaderScroll();
    initHeaderDate();
});
